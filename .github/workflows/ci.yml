name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  PHP_VERSION: '8.2'

jobs:
  lint-js:
    name: Lint JavaScript/TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint:js

      - name: Run Prettier check
        run: pnpm format:check

  lint-css:
    name: Lint SCSS
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Stylelint
        run: pnpm lint:css

  lint-php-wp:
    name: Lint PHP (WordPress)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: composer:v2

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: plugins/consentpro-wp
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-wp-${{ hashFiles('plugins/consentpro-wp/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-wp-

      - name: Install dependencies
        working-directory: plugins/consentpro-wp
        run: composer install --prefer-dist --no-progress

      - name: Run PHPCS
        working-directory: plugins/consentpro-wp
        run: composer phpcs

  lint-php-craft:
    name: Lint PHP (Craft)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2

      - name: Get Composer cache directory
        id: composer-cache
        working-directory: plugins/consentpro-craft
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-craft-${{ hashFiles('plugins/consentpro-craft/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-craft-

      - name: Install dependencies
        working-directory: plugins/consentpro-craft
        run: composer install --prefer-dist --no-progress

      - name: Check PHP syntax
        working-directory: plugins/consentpro-craft
        run: find src -name "*.php" -exec php -l {} \;

  build:
    name: Build Core Package
    runs-on: ubuntu-latest
    needs: [lint-js, lint-css]
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build core package
        run: pnpm --filter @consentpro/core build

      - name: Check bundle size
        run: |
          JS_SIZE=$(gzip -c packages/consentpro-core/dist/consentpro.min.js | wc -c)
          CSS_SIZE=$(gzip -c packages/consentpro-core/dist/consentpro.min.css | wc -c)
          TOTAL=$((JS_SIZE + CSS_SIZE))
          echo "JS: ${JS_SIZE} bytes gzipped"
          echo "CSS: ${CSS_SIZE} bytes gzipped"
          echo "Total: ${TOTAL} bytes gzipped"
          if [ $TOTAL -gt 5120 ]; then
            echo "::error::Bundle size exceeds 5KB gzipped limit! Total: ${TOTAL} bytes"
            exit 1
          fi
          echo "::notice::Bundle size OK: ${TOTAL} bytes (limit: 5120)"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: core-dist
          path: packages/consentpro-core/dist/

  test-core:
    name: Test Core Package
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Jest tests
        run: pnpm --filter @consentpro/core test:coverage
        continue-on-error: true  # Tests are stubs for now

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          directory: packages/consentpro-core/coverage
          fail_ci_if_error: false
        continue-on-error: true
