{#
 # ConsentPro Settings Template
 #
 # @link      https://consentpro.io
 # @copyright Copyright (c) ConsentPro Team
 #}

{% extends "_layouts/cp" %}

{% import '_includes/forms.twig' as forms %}

{# Define tabs #}
{% set tabs = {
    general: {
        label: 'General'|t('consentpro'),
        url: url('consentpro/settings', {tab: 'general'}),
    },
    appearance: {
        label: 'Appearance'|t('consentpro'),
        url: url('consentpro/settings', {tab: 'appearance'}),
    },
    categories: {
        label: 'Categories'|t('consentpro'),
        url: url('consentpro/settings', {tab: 'categories'}),
    },
    'consent-log': {
        label: 'Consent Log'|t('consentpro'),
        url: url('consentpro/settings', {tab: 'consent-log'}),
    },
    license: {
        label: 'License'|t('consentpro'),
        url: url('consentpro/settings', {tab: 'license'}),
    },
} %}

{# Set active tab #}
{% set selectedTab = selectedTab ?? 'general' %}

{# Show preview on Appearance and Categories tabs #}
{% set showPreview = selectedTab in ['appearance', 'categories'] %}

{# Enable full page form #}
{% set fullPageForm = true %}

{# Page title #}
{% set title = 'ConsentPro Settings'|t('consentpro') %}

{% block content %}
    {{ actionInput('consentpro/settings/save') }}
    {{ hiddenInput('selectedTab', selectedTab) }}
    {{ redirectInput(url('consentpro/settings', {tab: selectedTab})) }}

    <div class="consentpro-settings{% if showPreview %} consentpro-settings--with-preview{% endif %}">
        {# Main Content Area #}
        <div class="consentpro-settings__content">
            {# ============ GENERAL TAB ============ #}
            <div id="tab-general"{% if selectedTab != 'general' %} class="hidden"{% endif %}>
                {% include 'consentpro/settings/_tabs/general.twig' with {settings: settings} only %}
            </div>

            {# ============ APPEARANCE TAB ============ #}
            <div id="tab-appearance"{% if selectedTab != 'appearance' %} class="hidden"{% endif %}>
                {% include 'consentpro/settings/_tabs/appearance.twig' with {settings: settings} only %}
            </div>

            {# ============ CATEGORIES TAB ============ #}
            <div id="tab-categories"{% if selectedTab != 'categories' %} class="hidden"{% endif %}>
                {% include 'consentpro/settings/_tabs/categories.twig' with {settings: settings} only %}
            </div>

            {# ============ CONSENT LOG TAB ============ #}
            <div id="tab-consent-log"{% if selectedTab != 'consent-log' %} class="hidden"{% endif %}>
                {% include 'consentpro/settings/_tabs/consent-log.twig' with {settings: settings} only %}
            </div>

            {# ============ LICENSE TAB ============ #}
            <div id="tab-license"{% if selectedTab != 'license' %} class="hidden"{% endif %}>
                {% include 'consentpro/settings/_tabs/license.twig' with {settings: settings} only %}
            </div>
        </div>

        {# Live Preview Panel #}
        {% if showPreview %}
            <div class="consentpro-settings__preview">
                {% include 'consentpro/settings/_preview.twig' with {settings: settings} only %}
            </div>
        {% endif %}
    </div>

    {# Inline Styles for Settings Layout #}
    <style>
        .consentpro-settings {
            display: block;
        }
        .consentpro-settings--with-preview {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }
        @media (max-width: 1200px) {
            .consentpro-settings--with-preview {
                grid-template-columns: 1fr;
            }
            .consentpro-settings__preview {
                order: -1;
            }
        }
        .consentpro-settings__content {
            min-width: 0;
        }
        .consentpro-settings__preview {
            position: sticky;
            top: 24px;
            align-self: start;
        }
    </style>
{% endblock %}

{# Preview JavaScript for live updates #}
{% if showPreview %}
    {% js %}
            (function() {
                const preview = document.getElementById('consentpro-preview-iframe');
                if (!preview) return;

                // Debounce helper
                function debounce(fn, delay) {
                    let timer;
                    return function(...args) {
                        clearTimeout(timer);
                        timer = setTimeout(() => fn.apply(this, args), delay);
                    };
                }

                // Update preview on field changes
                const updatePreview = debounce(function() {
                    const config = collectConfig();
                    if (preview.contentWindow) {
                        preview.contentWindow.postMessage({
                            type: 'consentpro-preview-update',
                            config: config
                        }, '*');
                    }
                }, 300);

                // Collect current form values
                function collectConfig() {
                    return {
                        colors: {
                            primary: document.getElementById('colorPrimary')?.value || '#2563eb',
                            secondary: document.getElementById('colorSecondary')?.value || '#64748b',
                            background: document.getElementById('colorBackground')?.value || '#ffffff',
                            text: document.getElementById('colorText')?.value || '#1e293b',
                        },
                        text: {
                            heading: document.getElementById('textHeading')?.value || 'We value your privacy',
                            acceptAll: document.getElementById('textAccept')?.value || 'Accept All',
                            rejectNonEssential: document.getElementById('textReject')?.value || 'Reject Non-Essential',
                            settings: document.getElementById('textSettings')?.value || 'Cookie Settings',
                            save: document.getElementById('textSave')?.value || 'Save Preferences',
                        },
                        categories: collectCategories(),
                    };
                }

                // Collect category values
                function collectCategories() {
                    const cats = [];
                    ['essential', 'analytics', 'marketing', 'personalization'].forEach(id => {
                        const nameEl = document.querySelector('[name="categories[' + id + '][name]"]');
                        const descEl = document.querySelector('[name="categories[' + id + '][description]"]');
                        if (nameEl || descEl) {
                            cats.push({
                                id: id,
                                name: nameEl?.value || id.charAt(0).toUpperCase() + id.slice(1),
                                description: descEl?.value || '',
                                required: id === 'essential',
                            });
                        }
                    });
                    return cats;
                }

                // Bind event listeners
                const inputs = document.querySelectorAll(
                    '#tab-appearance input, #tab-appearance textarea, ' +
                    '#tab-categories input, #tab-categories textarea'
                );

                inputs.forEach(input => {
                    input.addEventListener('input', updatePreview);
                    input.addEventListener('change', updatePreview);
                });

                // Layer toggle buttons
                document.querySelectorAll('.consentpro-preview-layer-toggle').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const layer = this.dataset.layer;
                        document.querySelectorAll('.consentpro-preview-layer-toggle').forEach(b => {
                            b.classList.remove('active');
                            b.setAttribute('aria-pressed', 'false');
                        });
                        this.classList.add('active');
                        this.setAttribute('aria-pressed', 'true');

                        if (preview.contentWindow) {
                            preview.contentWindow.postMessage({
                                type: 'consentpro-preview-layer',
                                layer: parseInt(layer)
                            }, '*');
                        }
                    });
                });

                // Viewport toggle buttons
                document.querySelectorAll('.consentpro-preview-viewport-toggle').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const viewport = this.dataset.viewport;
                        document.querySelectorAll('.consentpro-preview-viewport-toggle').forEach(b => {
                            b.classList.remove('active');
                            b.setAttribute('aria-pressed', 'false');
                        });
                        this.classList.add('active');
                        this.setAttribute('aria-pressed', 'true');

                        const iframe = document.getElementById('consentpro-preview-iframe');
                        if (iframe) {
                            iframe.style.width = viewport === 'mobile' ? '375px' : '100%';
                        }
                    });
                });

                // Initial update when iframe loads
                preview.addEventListener('load', function() {
                    updatePreview();
                });
            })();
    {% endjs %}
{% endif %}
